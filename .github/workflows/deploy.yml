name: Deploy to Alibaba Cloud ESA

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # âœ… ä½¿ç”¨ v4

      - name: Setup Node.js
        uses: actions/setup-node@v4  # âœ… ä½¿ç”¨ v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build project
        run: npm run build
        env:
          VITE_OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4  # âœ… ä½¿ç”¨ v4
        with:
          name: dist
          path: dist/
          retention-days: 5

      - name: Verify build
        run: |
          echo "æ„å»ºå®Œæˆï¼"
          ls -la dist/
          echo "æ–‡ä»¶æ•°é‡: $(find dist -type f | wc -l)"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4  # âœ… ä½¿ç”¨ v4
        with:
          name: dist
          path: dist

      - name: List files for verification
        run: ls -la dist/

      - name: Notify deployment ready
        run: |
          echo "ğŸš€ æ„å»ºå®Œæˆï¼Œå‡†å¤‡éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ESA"
          echo "è¯·æ‰‹åŠ¨ä¸Šä¼  dist/ ç›®å½•åˆ° ESA æ§åˆ¶å°"
